<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Drawio Server</title>
  <style>
    :root {
      --bg: #f5f5f5;
      --panel: #ffffff;
      --surface: #fafafa;
      --muted: #605e5c;
      --border: #edebe9;
      --border-strong: #d2d0ce;
      --accent: #0078d4;
      --accent-hover: #106ebe;
      --accent-light: #e1f0ff;
      --text: #323130;
      --text-secondary: #605e5c;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
      --radius: 4px;
      --radius-lg: 8px;
      --sidebar-width: 240px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, "Roboto", "Helvetica Neue", sans-serif;
      margin: 0;
      color: var(--text);
      background: var(--bg);
      font-size: 14px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    .layout {
      display: grid;
      grid-template-columns: var(--sidebar-width) 1fr;
      min-height: 100vh;
    }

    aside {
      height: 100vh;
      border-right: 1px solid var(--border);
      background: var(--panel);
      padding: 12px 0;
      position: sticky;
      top: 0;
      box-shadow: var(--shadow-sm);
    }

    main {
      min-height: 100vh;
      background: var(--surface);
      display: flex;
      flex-direction: column;
    }

    header.top {
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      gap: 16px;
      border-bottom: 1px solid var(--border);
      background: var(--panel);
      position: sticky;
      top: 0;
      z-index: 10;
      flex-wrap: wrap;
    }

    .app {
      padding: 24px;
      flex: 1;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }

    input,
    button,
    select,
    a.button {
      font-family: inherit;
      font-size: 14px;
      color: var(--text);
      border-radius: var(--radius);
      padding: 8px 12px;
      transition: background 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
    }

    input {
      background: var(--panel);
      border: 1px solid var(--border);
    }

    input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent);
    }

    input::placeholder {
      color: var(--muted);
    }

    button,
    a.button {
      background: var(--panel);
      border: 1px solid var(--border);
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    button:hover,
    a.button:hover {
      background: var(--surface);
      border-color: var(--border-strong);
    }

    button.primary,
    a.button.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    button.primary:hover,
    a.button.primary:hover {
      background: var(--accent-hover);
      border-color: var(--accent-hover);
    }

    .muted {
      color: var(--text-secondary);
      font-size: 12px;
    }

    .nav {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .nav a,
    .nav button {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      border-radius: 0;
      background: transparent;
      border: none;
      border-left: 3px solid transparent;
      color: var(--text);
      text-decoration: none;
      width: 100%;
      text-align: left;
      font: inherit;
      margin: 0;
    }

    .nav a:hover,
    .nav button:hover {
      background: var(--surface);
    }

    .nav a[href="#"]:not(.active):hover,
    .nav button:hover {
      background: #f3f2f1;
    }

    .nav .icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    .crumbs {
      display: flex;
      gap: 4px;
      align-items: center;
      flex-wrap: wrap;
      font-size: 14px;
    }

    .crumbs a {
      color: var(--accent);
      padding: 4px 6px;
      margin: 0 -6px;
      border-radius: var(--radius);
      text-decoration: none;
    }

    .crumbs a:hover {
      background: var(--accent-light);
      color: var(--accent-hover);
    }

    .crumbs .separator {
      color: var(--muted);
      user-select: none;
      font-size: 12px;
    }

    .toolbar {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    #filter {
      min-width: 200px;
      max-width: 320px;
      padding: 8px 12px 8px 32px;
      background: var(--surface) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23605e5c' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E") no-repeat 10px center;
    }

    table.files {
      width: 100%;
      border-collapse: collapse;
    }

    table.files th,
    table.files td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }

    table.files th {
      color: var(--muted);
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      text-align: left;
      background: #f3f2f1;
      position: sticky;
      top: 0;
      z-index: 2;
      border-bottom: 2px solid var(--border);
    }

    table.files th:last-child {
      width: 1%;
      min-width: 200px;
      text-align: right;
    }

    table.files tbody tr {
      transition: background 0.12s ease;
    }

    table.files tbody tr:hover {
      background: #f3f2f1;
    }

    table.files tbody tr:hover .namecell .file-name {
      color: var(--accent);
    }

    table.files tbody tr:last-child td {
      border-bottom: none;
    }

    /* Show row actions on hover (desktop); keep visible on touch */
    @media (hover: hover) {
      table.files tbody tr .row-actions {
        opacity: 0;
        transition: opacity 0.15s ease;
      }

      table.files tbody tr:hover .row-actions,
      table.files tbody tr .row-actions:focus-within {
        opacity: 1;
      }
    }

    .namecell {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }

    .namecell .file-name {
      min-width: 0;
      transition: color 0.12s ease;
    }

    .icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius);
      flex-shrink: 0;
    }

    .icon.folder {
      background-color: var(--accent);
      -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2'%3E%3Cpath d='M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z'/%3E%3C/svg%3E") center/18px no-repeat;
      mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2'%3E%3Cpath d='M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z'/%3E%3C/svg%3E") center/18px no-repeat;
    }

    .icon.file {
      background-color: var(--muted);
      -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2'%3E%3Cpath d='M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z'/%3E%3Cpolyline points='14 2 14 8 20 8'/%3E%3Cline x1='16' y1='13' x2='8' y2='13'/%3E%3Cline x1='16' y1='17' x2='8' y2='17'/%3E%3C/svg%3E") center/18px no-repeat;
      mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2'%3E%3Cpath d='M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z'/%3E%3Cpolyline points='14 2 14 8 20 8'/%3E%3Cline x1='16' y1='13' x2='8' y2='13'/%3E%3Cline x1='16' y1='17' x2='8' y2='17'/%3E%3C/svg%3E") center/18px no-repeat;
    }

    .icon.gear {
      background-color: var(--muted);
      -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2'%3E%3Ccircle cx='12' cy='12' r='3'/%3E%3Cpath d='M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z'/%3E%3C/svg%3E") center/18px no-repeat;
      mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2'%3E%3Ccircle cx='12' cy='12' r='3'/%3E%3Cpath d='M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z'/%3E%3C/svg%3E") center/18px no-repeat;
    }

    .row-actions {
      display: flex;
      gap: 6px;
      justify-content: flex-end;
      flex-wrap: nowrap;
      align-items: center;
    }

    .row-actions a,
    .row-actions button {
      padding: 6px 10px;
      font-size: 12px;
      border-radius: var(--radius);
      white-space: nowrap;
    }

    /* Empty state when no files */
    .files-empty {
      padding: 48px 24px;
      text-align: center;
      color: var(--muted);
      background: var(--panel);
    }

    .files-empty-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }

    .files-empty-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    /* Version history modal */
    .version-history-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 40;
      backdrop-filter: blur(2px);
    }

    .version-history-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: min(960px, 94vw);
      max-height: 88vh;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      z-index: 50;
      overflow: hidden;
      flex-direction: column;
    }

    .version-history-modal .vhm-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--panel);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .version-history-modal .vhm-title {
      font-weight: 600;
      font-size: 16px;
      color: var(--text);
    }

    .version-history-modal .vhm-body {
      overflow: auto;
      padding: 20px 24px;
      flex: 1;
      min-height: 0;
    }

    .version-history-modal table {
      width: 100%;
      border-collapse: collapse;
    }

    .version-history-modal th {
      text-align: left;
      padding: 10px 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
      background: var(--surface);
    }

    .version-history-modal td {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }

    .version-history-modal tr:hover {
      background: var(--surface);
    }

    .version-history-modal .version-date-absolute {
      font-weight: 600;
      color: var(--accent);
      white-space: nowrap;
    }

    .version-history-modal .version-date {
      color: var(--text);
      white-space: nowrap;
    }

    .version-history-modal .version-commit {
      font-family: ui-monospace, monospace;
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    .version-history-modal .version-by {
      color: var(--muted);
      font-size: 13px;
    }

    .version-history-modal .version-msg {
      color: var(--muted);
      font-size: 12px;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .version-history-modal .version-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .version-history-modal .version-actions button {
      padding: 6px 12px;
      font-size: 13px;
    }

    .version-history-modal .version-actions .btn-restore {
      background: var(--accent-light);
      color: var(--accent);
      border-color: transparent;
    }

    .version-history-modal .version-actions .btn-restore:hover {
      background: #cce4ff;
    }

    .version-history-empty {
      color: var(--muted);
      padding: 32px;
      text-align: center;
    }

    /* Settings modal */
    .settings-backdrop {
      backdrop-filter: blur(2px);
    }
  </style>
</head>

<body>
  <div class="layout">
    <aside>
      <div class="brand"
        style="padding: 14px 16px 8px; font-weight: 600; font-size: 15px; color: var(--text); border-bottom: 1px solid var(--border); margin-bottom: 8px;">
        Drawio</div>
      <div class="nav">
        <a href="#" id="nav-root"><span class="icon folder"></span><span>My files</span></a>
        <button id="nav-new-folder"><span class="icon folder"></span><span>New folder</span></button>
        <button id="nav-new-file"><span class="icon file"></span><span>New file</span></button>
        <button id="nav-upload"><span class="icon file"></span><span>Upload file</span></button>
        <button id="nav-settings"><span class="icon gear"></span><span>Settings</span></button>

      </div>

    </aside>
    <main>
      <header class="top">
        <div class="crumbs" id="crumbs"></div>
        <div class="toolbar">
          <input id="filter" placeholder="Search" />
          <button id="refresh">Refresh</button>
          <button id="upload-btn" class="primary">Upload</button>
          <span class="muted" id="greeting">Hello, guest</span>
        </div>
      </header>
      <div class="app">
        <div class="card file-list-card" style="overflow: auto;">
          <div id="files-empty" class="files-empty" style="display: none;">
            <div class="files-empty-title" id="files-empty-title">No files in this folder</div>
            <p class="muted" id="files-empty-desc" style="margin: 0;">Upload a diagram or create a new file to get
              started.</p>
            <div class="files-empty-actions" id="files-empty-actions">
              <button type="button" id="empty-upload-btn" class="primary">Upload file</button>
              <button type="button" id="empty-new-file-btn">New file</button>
            </div>
          </div>
          <table class="files" id="file-table">
            <thead>
              <tr>
                <th style="width:50%;">Name</th>
                <th style="width:20%;">Size</th>
                <th style="width:30%;">Last modified</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="file-tbody"></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
  <!-- Hidden file input for upload -->
  <input type="file" id="file-input" accept=".drawio" style="display: none;" />
  <!-- Version history modal (SharePoint-style) -->
  <div id="version-history-backdrop" class="version-history-backdrop"></div>
  <div id="version-history-modal" class="version-history-modal">
    <div class="vhm-header">
      <span class="vhm-title" id="version-history-title">Version history</span>
      <button type="button" id="version-history-close">Close</button>
    </div>
    <div class="vhm-body">
      <div id="version-history-loading" class="version-history-empty" style="display:none;">Loading versions…</div>
      <div id="version-history-empty" class="version-history-empty" style="display:none;">No version history for this
        file.</div>
      <table id="version-history-table" style="display:none;">
        <thead>
          <tr>
            <th>Date</th>
            <th>Modified</th>
            <th>Commit</th>
            <th>Modified by</th>
            <th>Description</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="version-history-tbody"></tbody>
      </table>
    </div>
  </div>
  <!-- Settings modal -->
  <div id="settings-backdrop" class="settings-backdrop"
    style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 40;"></div>
  <div id="settings-modal" class="settings-modal"
    style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: min(400px, 92vw); z-index: 50;">
    <div class="card" style="padding: 24px; box-shadow: var(--shadow-lg);">
      <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <strong style="font-size: 18px;">Settings</strong>
        <button id="settings-close">Close</button>
      </div>
      <div style="display:grid; gap: 12px;">
        <label class="muted" style="font-size: 13px;">Display name</label>
        <input id="settings-name" placeholder="Your display name" />
        <button id="settings-save" class="primary" style="margin-top: 8px;">Save</button>
      </div>
    </div>
  </div>
  <script>
    const $ = (id) => document.getElementById(id);
    const greeting = $('greeting');
    const statusEl = $('status');
    const versionBadge = $('version-badge');
    const crumbs = $('crumbs');
    const fileBody = $('file-tbody');

    let cwd = '';

    // Helper function to add token to URLs
    function addTokenToUrl(url) {
      const storedToken = localStorage.getItem('drawio_token');
      if (!storedToken) return url;
      const separator = url.includes('?') ? '&' : '?';
      return `${url}${separator}token=${encodeURIComponent(storedToken)}`;
    }

    async function fetchJSON(url, opts = {}) {
      const res = await fetch(addTokenToUrl(url), { credentials: 'include', ...opts });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }
    async function fetchText(url, opts = {}) {
      const res = await fetch(addTokenToUrl(url), { credentials: 'include', ...opts });
      if (!res.ok) throw new Error(await res.text());
      return res.text();
    }

    async function refreshMe() {
      try {
        const me = await fetchJSON('/me');
        greeting.textContent = 'Hello, ' + me.username;
        // Store token from URL if present (for persistence across sessions)
        const urlToken = new URLSearchParams(location.search).get('token');
        if (urlToken) {
          localStorage.setItem('drawio_token', urlToken);
          // Clean URL to remove token from address bar
          const url = new URL(location);
          url.searchParams.delete('token');
          history.replaceState({}, '', url);
        }
      } catch {
        greeting.textContent = 'Hello, guest';
      }
    }
    async function refreshFiles() {
      const filesEmptyEl = $('files-empty');
      const fileTableEl = $('file-table');
      fileBody.innerHTML = '';
      try {
        updateBreadcrumbs();
        const files = await fetchJSON('/api/list?path=' + encodeURIComponent(cwd));
        const q = ($('filter')?.value || '').toLowerCase();
        const filtered = files.filter(x => !q || x.name.toLowerCase().includes(q));
        if (filtered.length === 0) {
          if (filesEmptyEl) {
            filesEmptyEl.style.display = 'block';
            const isSearch = q.length > 0 && files.length > 0;
            $('files-empty-title').textContent = isSearch ? 'No matching files' : 'No files in this folder';
            $('files-empty-desc').textContent = isSearch ? 'Try a different search term.' : 'Upload a diagram or create a new file to get started.';
            $('files-empty-actions').style.display = isSearch ? 'none' : 'flex';
          }
          if (fileTableEl) fileTableEl.style.display = 'none';
        } else {
          if (filesEmptyEl) filesEmptyEl.style.display = 'none';
          if (fileTableEl) fileTableEl.style.display = 'table';
        }
        for (const f of filtered) {
          const tr = document.createElement('tr');
          const tdName = document.createElement('td');
          const tdSize = document.createElement('td');
          const tdMod = document.createElement('td');
          const tdAct = document.createElement('td');
          const nameCell = document.createElement('div');
          nameCell.className = 'namecell';
          const dot = document.createElement('span');
          dot.className = 'icon ' + (f.is_dir ? 'folder' : 'file');
          const label = document.createElement('span');
          label.className = 'file-name';
          label.textContent = f.name + (f.is_dir ? '/' : '');
          label.style.whiteSpace = 'nowrap';
          label.style.overflow = 'hidden';
          label.style.textOverflow = 'ellipsis';
          label.style.display = 'block';
          nameCell.appendChild(dot);
          nameCell.appendChild(label);
          tdName.appendChild(nameCell);
          tdName.style.cursor = 'pointer';
          tdName.onclick = () => {
            if (f.is_dir) {
              cwd = f.path;
              refreshFiles();
            } else {
              const token = localStorage.getItem('drawio_token') || '';
              const url = `/drawio.html?path=${encodeURIComponent(f.path)}${token ? '&token=' + encodeURIComponent(token) : ''}`;
              window.location.href = url;
            }
          };
          tdSize.textContent = f.is_dir ? '–' : formatSize(f.size || 0);
          tdMod.textContent = f.modified_ms ? formatRelative(f.modified_ms) : '–';
          const actions = document.createElement('div');
          actions.className = 'row-actions';
          const btnOpen = document.createElement('a');
          btnOpen.className = 'button';
          btnOpen.textContent = 'Open';
          const token = localStorage.getItem('drawio_token') || '';
          btnOpen.href = f.is_dir ? '#' : `/drawio.html?path=${encodeURIComponent(f.path)}${token ? '&token=' + encodeURIComponent(token) : ''}`;
          btnOpen.onclick = (ev) => { if (f.is_dir) { ev.preventDefault(); cwd = f.path; refreshFiles(); } };
          const btnDownload = document.createElement('a');
          btnDownload.className = 'button';
          btnDownload.textContent = 'Download';
          btnDownload.href = `/api/download?path=${encodeURIComponent(f.path)}`;
          btnDownload.style.display = f.is_dir ? 'none' : 'inline-block';
          const btnRename = document.createElement('button');
          btnRename.textContent = 'Rename';
          btnRename.onclick = async () => {
            const newName = prompt('Rename to:', f.name);
            if (!newName || newName === f.name) return;
            if (!f.is_dir && !newName.endsWith('.drawio')) return alert('Name must end with .drawio');
            try {
              const res = await fetch(addTokenToUrl('/api/rename'), {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ from: f.path, to: (cwd ? (cwd + '/' + newName) : newName) }),
              });
              if (!res.ok) throw new Error(await res.text());
              await refreshFiles();
            } catch (e) { alert(e.message); }
          };
          const btnDelete = document.createElement('button');
          btnDelete.textContent = 'Delete';
          btnDelete.onclick = async () => {
            if (!confirm(`Delete ${f.name}${f.is_dir ? ' (folders must be empty)' : ''}?`)) return;
            try {
              if (f.is_dir) {
                alert('Folder deletion not implemented yet');
                return;
              }
              const res = await fetch(addTokenToUrl(`/api/file?path=${encodeURIComponent(f.path)}`), {
                method: 'DELETE',
                credentials: 'include',
              });
              if (!res.ok) throw new Error(await res.text());
              await refreshFiles();
            } catch (e) { alert(e.message); }
          };
          const btnVersionHistory = document.createElement('button');
          btnVersionHistory.textContent = 'Version history';
          btnVersionHistory.style.display = f.is_dir ? 'none' : 'inline-block';
          btnVersionHistory.onclick = () => openVersionHistory(f.path, f.name);
          actions.appendChild(btnOpen);
          actions.appendChild(btnDownload);
          actions.appendChild(btnVersionHistory);
          actions.appendChild(btnRename);
          actions.appendChild(btnDelete);
          tdAct.appendChild(actions);
          tr.appendChild(tdName);
          tr.appendChild(tdSize);
          tr.appendChild(tdMod);
          tr.appendChild(tdAct);
          fileBody.appendChild(tr);
        }
      } catch (e) {
        //console.error(e);
      }
    }

    // Settings modal open/close/save
    const settingsBtn = $('nav-settings');
    const settingsModal = $('settings-modal');
    const settingsBackdrop = $('settings-backdrop');
    const settingsClose = $('settings-close');
    const settingsSave = $('settings-save');
    const settingsName = $('settings-name');
    function openSettings() {
      settingsModal.style.display = 'block';
      settingsBackdrop.style.display = 'block';
      const current = (greeting.textContent || '').replace(/^Hello,\s*/, '') || 'guest';
      settingsName.value = current === 'guest' ? '' : current;
      settingsName.focus();
    }
    function closeSettings() {
      settingsModal.style.display = 'none';
      settingsBackdrop.style.display = 'none';
    }
    if (settingsBtn) settingsBtn.onclick = (e) => { e.preventDefault(); openSettings(); };
    if (settingsBackdrop) settingsBackdrop.onclick = closeSettings;
    if (settingsClose) settingsClose.onclick = closeSettings;
    if (settingsSave) settingsSave.onclick = async () => {
      const username = settingsName.value.trim();
      if (!username) return alert('enter a display name');
      try {
        // Use token from localStorage or URL query params as fallback
        const storedToken = localStorage.getItem('drawio_token');
        const urlToken = new URLSearchParams(location.search).get('token');
        const token = storedToken || urlToken || '';
        const res = await fetch('/me?token=' + encodeURIComponent(token), {
          method: 'PUT',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username }),
        });
        if (!res.ok) throw new Error(await res.text());
        await refreshMe();
        closeSettings();
      } catch (e) { alert(e.message); }
    };
    $('logout')?.addEventListener('click', async () => {
      await fetch(addTokenToUrl('/logout'), { method: 'POST', credentials: 'include' });
      // Clear stored token on logout
      localStorage.removeItem('drawio_token');
      // Redirect to login page
      location.href = '/token.html';
    });
    $('refresh').onclick = refreshFiles;
    $('nav-root').onclick = (e) => { e.preventDefault(); cwd = ''; refreshFiles(); };

    // Upload functionality
    const fileInput = $('file-input');
    const uploadBtn = $('upload-btn');
    const navUpload = $('nav-upload');

    async function handleFileUpload(file) {
      if (!file) return;

      // Check if file has .drawio extension
      if (!file.name.endsWith('.drawio')) {
        if (!confirm('File does not end with .drawio. Upload anyway? (extension will be added)')) {
          return;
        }
      }

      const formData = new FormData();
      formData.append('file', file);

      // Build URL with optional path query parameter
      let url = '/api/upload';
      if (cwd) {
        // If in a subdirectory, suggest the path with the filename
        const suggestedPath = cwd + '/' + file.name;
        url += '?path=' + encodeURIComponent(suggestedPath);
      }

      try {
        const res = await fetch(addTokenToUrl(url), {
          method: 'POST',
          credentials: 'include',
          body: formData,
        });

        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(errorText || 'Upload failed');
        }

        const result = await res.json();
        alert(`File uploaded successfully: ${result.path}`);
        await refreshFiles();
      } catch (e) {
        alert('Upload error: ' + e.message);
      }
    }

    fileInput.onchange = (e) => {
      const file = e.target.files?.[0];
      if (file) {
        handleFileUpload(file);
      }
      // Reset input so same file can be selected again
      fileInput.value = '';
    };

    if (uploadBtn) {
      uploadBtn.onclick = () => fileInput.click();
    }
    if (navUpload) {
      navUpload.onclick = () => fileInput.click();
    }
    $('empty-upload-btn')?.addEventListener('click', () => fileInput?.click());
    $('empty-new-file-btn')?.addEventListener('click', () => $('nav-new-file')?.click());

    $('nav-new-folder').onclick = async () => {
      const name = prompt('Folder name:');
      if (!name) return;
      const full = cwd ? (cwd + '/' + name) : name;
      const res = await fetch(addTokenToUrl('/api/mkdir'), { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ path: full }) });
      if (!res.ok) return alert(await res.text());
      refreshFiles();
    };
    $('nav-new-file').onclick = async () => {
      const name = prompt('New diagram name (ends with .drawio):');
      if (!name || !name.endsWith('.drawio')) return;
      const full = cwd ? (cwd + '/' + name) : name;
      const content = getTemplateXml('blank');
      const res = await fetch(addTokenToUrl(`/api/file?path=${encodeURIComponent(full)}`), { method: 'PUT', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content }) });
      if (!res.ok) return alert(await res.text());
      refreshFiles();
    };

    function updateBreadcrumbs() {
      const parts = cwd ? cwd.split('/') : [];
      crumbs.innerHTML = '';
      const root = document.createElement('a');
      root.href = '#';
      root.textContent = 'My files';
      root.onclick = (e) => { e.preventDefault(); cwd = ''; refreshFiles(); };
      crumbs.appendChild(root);
      let pathAcc = '';
      for (const p of parts) {
        const sep = document.createElement('span');
        sep.className = 'separator';
        sep.textContent = '›';
        sep.setAttribute('aria-hidden', 'true');
        crumbs.appendChild(sep);
        pathAcc = pathAcc ? (pathAcc + '/' + p) : p;
        const a = document.createElement('a');
        a.href = '#';
        a.textContent = p;
        const jump = pathAcc;
        a.onclick = (e) => { e.preventDefault(); cwd = jump; refreshFiles(); };
        crumbs.appendChild(a);
      }
    }

    function formatSize(n) {
      const units = ['B', 'KB', 'MB', 'GB', 'TB'];
      let i = 0; let x = n;
      while (x >= 1024 && i < units.length - 1) { x /= 1024; i++; }
      return (i === 0 ? x : x.toFixed(2)) + ' ' + units[i];
    }
    function formatRelative(ms) {
      const now = Date.now();
      const d = Math.max(0, now - ms);
      const s = Math.floor(d / 1000);
      if (s < 60) return 'just now';
      const m = Math.floor(s / 60);
      if (m < 60) return `${m} minute${m === 1 ? '' : 's'} ago`;
      const h = Math.floor(m / 60);
      if (h < 24) return `${h} hour${h === 1 ? '' : 's'} ago`;
      const days = Math.floor(h / 24);
      return `${days} day${days === 1 ? '' : 's'} ago`;
    }
    function getTemplateXml(kind) {
      if (kind === 'flow') {
        return '<?xml version="1.0" encoding="UTF-8"?><mxfile><diagram name="Page-1"><mxGraphModel><root><mxCell id="0"/><mxCell id="1" parent="0"/><mxCell id="2" value="Start" style="ellipse;whiteSpace=wrap;html=1;aspect=fixed;" vertex="1" parent="1"><mxGeometry x="120" y="80" width="80" height="80" as="geometry"/></mxCell><mxCell id="3" value="Process" style="rounded=1;whiteSpace=wrap;html=1;" vertex="1" parent="1"><mxGeometry x="260" y="80" width="120" height="60" as="geometry"/></mxCell><mxCell id="4" edge="1" parent="1" source="2" target="3"><mxGeometry relative="1" as="geometry"/></mxCell></root></mxGraphModel></diagram></mxfile>';
      }
      return '<?xml version="1.0" encoding="UTF-8"?><mxfile><diagram name="Page-1"><mxGraphModel><root><mxCell id="0"/><mxCell id="1" parent="0"/></root></mxGraphModel></diagram></mxfile>';
    }

    // ----- Version history (SharePoint-style) -----
    let versionHistoryFilePath = '';
    const vhBackdrop = $('version-history-backdrop');
    const vhModal = $('version-history-modal');
    const vhTitle = $('version-history-title');
    const vhLoading = $('version-history-loading');
    const vhEmpty = $('version-history-empty');
    const vhTable = $('version-history-table');
    const vhTbody = $('version-history-tbody');

    function formatVersionDate(isoStr) {
      if (!isoStr) return '–';
      const d = new Date(isoStr);
      const now = new Date();
      const diffMs = now - d;
      const diffM = Math.floor(diffMs / 60000);
      const diffH = Math.floor(diffMs / 3600000);
      const diffD = Math.floor(diffMs / 86400000);
      if (diffM < 1) return 'Just now';
      if (diffM < 60) return diffM + ' minute' + (diffM === 1 ? '' : 's') + ' ago';
      if (diffH < 24) return diffH + ' hour' + (diffH === 1 ? '' : 's') + ' ago';
      if (diffD < 7) return diffD + ' day' + (diffD === 1 ? '' : 's') + ' ago';
      return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    function formatVersionDateAbsolute(isoStr) {
      if (!isoStr) return '–';
      const d = new Date(isoStr);
      return d.toLocaleDateString(undefined, { day: 'numeric', month: 'short', year: 'numeric' }) + ', ' + d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
    }

    function openVersionHistory(filePath, fileName) {
      versionHistoryFilePath = filePath;
      vhTitle.textContent = 'Version history – ' + (fileName || filePath);
      vhBackdrop.style.display = 'block';
      vhModal.style.display = 'flex';
      vhLoading.style.display = 'block';
      vhEmpty.style.display = 'none';
      vhTable.style.display = 'none';
      vhTbody.innerHTML = '';
      loadVersionHistory();
    }

    function closeVersionHistory() {
      vhBackdrop.style.display = 'none';
      vhModal.style.display = 'none';
      versionHistoryFilePath = '';
    }

    async function loadVersionHistory() {
      if (!versionHistoryFilePath) return;
      try {
        const data = await fetchJSON('/api/versions?path=' + encodeURIComponent(versionHistoryFilePath));
        vhLoading.style.display = 'none';
        const versions = data.versions || [];
        if (versions.length === 0) {
          vhEmpty.style.display = 'block';
          vhTable.style.display = 'none';
          return;
        }
        vhEmpty.style.display = 'none';
        vhTable.style.display = 'table';
        vhTbody.innerHTML = '';
        versions.forEach((v) => {
          const tr = document.createElement('tr');
          const ts = v.timestamp || '';
          const shortHash = (v.commit_oid || '').substring(0, 7);
          const commitTitle = (v.commit_oid || '').replace(/"/g, '&quot;');
          tr.innerHTML =
            '<td class="version-date-absolute">' + formatVersionDateAbsolute(ts) + '</td>' +
            '<td class="version-date">' + formatVersionDate(ts) + '</td>' +
            '<td class="version-commit" title="' + commitTitle + '">' + (shortHash || '–') + '</td>' +
            '<td class="version-by">' + (v.username || '–') + '</td>' +
            '<td class="version-msg" title="' + (v.message || '').replace(/"/g, '&quot;') + '">' + (v.message || '–') + '</td>' +
            '<td><div class="version-actions"></div></td>';
          const actions = tr.querySelector('.version-actions');
          const btnOpenReadOnly = document.createElement('a');
          btnOpenReadOnly.className = 'button';
          btnOpenReadOnly.textContent = 'Open read-only';
          btnOpenReadOnly.href = addTokenToUrl('/drawio.html?path=' + encodeURIComponent(versionHistoryFilePath) + '&version=' + encodeURIComponent(v.commit_oid) + '&readonly=1');
          btnOpenReadOnly.target = '_blank';
          btnOpenReadOnly.rel = 'noopener';
          const btnDownload = document.createElement('button');
          btnDownload.textContent = 'Download';
          btnDownload.onclick = () => {
            const url = addTokenToUrl('/api/download?path=' + encodeURIComponent(versionHistoryFilePath) + '&version=' + encodeURIComponent(v.commit_oid));
            window.open(url, '_blank');
          };
          const btnRestore = document.createElement('button');
          btnRestore.className = 'btn-restore';
          btnRestore.textContent = 'Restore';
          btnRestore.onclick = async () => {
            if (!confirm('Restore this version? The current file will be replaced and a new version will be created.')) return;
            try {
              const res = await fetch(addTokenToUrl('/api/versions?path=' + encodeURIComponent(versionHistoryFilePath)), {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ commit_oid: v.commit_oid }),
              });
              if (!res.ok) throw new Error(await res.text());
              closeVersionHistory();
              await refreshFiles();
            } catch (e) { alert(e.message); }
          };
          actions.appendChild(btnOpenReadOnly);
          actions.appendChild(btnDownload);
          actions.appendChild(btnRestore);
          vhTbody.appendChild(tr);
        });
      } catch (e) {
        vhLoading.style.display = 'none';
        vhEmpty.style.display = 'block';
        vhEmpty.textContent = 'Could not load version history: ' + e.message;
        vhTable.style.display = 'none';
      }
    }

    $('version-history-close').onclick = closeVersionHistory;
    if (vhBackdrop) vhBackdrop.onclick = closeVersionHistory;

    refreshMe();
    refreshFiles();
    // load viewer script for previews
    (function loadViewer() {
      const s = document.createElement('script');
      s.src = 'https://viewer.diagrams.net/js/viewer.min.js';
      s.async = true;
      document.body.appendChild(s);
    })();
  </script>
</body>

</html>