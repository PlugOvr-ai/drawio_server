<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DrawioServer - Demo</title>
  <style>
    :root {
      --bg: #ffffff;
      --panel: #ffffff;
      --muted: #6b7280;     /* gray-500 */
      --border: #e5e7eb;    /* gray-200 */
      --accent: #2563eb;    /* blue-600 */
      --text: #111827;      /* gray-900 */
    }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; color: var(--text); background: var(--bg); }
    .layout { display: grid; grid-template-columns: 260px 1fr; }
    aside { height: 100vh; border-right: 1px solid var(--border); background: #f8fafc; padding: 16px 12px; position: sticky; top: 0; }
    main { min-height: 100vh; background: #f9fafb; }
    header.top { height: 56px; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; border-bottom: 1px solid var(--border); background: #f8fafc; position: sticky; top: 0; z-index: 10; }
    .app { padding: 16px; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 10px; }
    input, button, select, a.button { background: #ffffff; color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; }
    button, a.button { cursor: pointer; }
    .muted { color: var(--muted); font-size: 12px; }
    .nav { display: grid; gap: 8px; }
    .nav a, .nav button {
      display: grid;
      grid-template-columns: 24px 1fr;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 8px;
      background: transparent;
      border: 1px solid transparent;
      color: var(--text);
      text-decoration: none;
      width: 100%;
      text-align: left;
      font: inherit;
    }
    .nav a:hover, .nav button:hover { background: #f3f4f6; border-color: var(--border); }
    .nav a:active, .nav button:active { border-color: var(--accent); }
    .crumbs { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .toolbar { display: flex; gap: 8px; align-items: center; }
    table.files { width: 100%; border-collapse: collapse; }
    table.files th, table.files td { padding: 10px 12px; border-bottom: 1px solid var(--border); }
    table.files th { color: var(--muted); font-weight: 600; text-align: left; background: #f3f4f6; position: sticky; top: 0; z-index: 2; box-shadow: 0 1px 0 var(--border); }
    table.files tr:hover { background: #f9fafb; }
    .namecell { display: grid; grid-template-columns: 24px 1fr; align-items: center; gap: 8px; }
    .icon { width: 16px; height: 16px; display: inline-block; border-radius: 3px; background: #9ca3af; justify-self: center; }
    .folder { background: #60a5fa; }
    .file { background: #9ca3af; }
    .gear { background: #93c5fd; }
    .row-actions { display: flex; gap: 8px; justify-content: flex-end; }
    /* Uniform action button look */
    .row-actions a, .row-actions button {
      background: #ffffff;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 12px;
      text-decoration: none;
      font: inherit;
    }
    .row-actions a:hover, .row-actions button:hover {
      background: #f3f4f6;
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside>
      <div class="nav">
        <a href="#" id="nav-root"><span class="icon folder"></span><span>My files</span></a>
        <button id="nav-new-folder"><span class="icon folder"></span><span>New folder</span></button>
        <button id="nav-new-file"><span class="icon file"></span><span>New file</span></button>
        <button id="nav-upload"><span class="icon file"></span><span>Upload file</span></button>
        <button id="nav-settings"><span class="icon gear"></span><span>Settings</span></button>

      </div>

    </aside>
    <main>
      <header class="top">
        <div class="crumbs" id="crumbs"></div>
        <div class="toolbar">
          <input id="filter" placeholder="Search" />
          <button id="refresh">Refresh</button>
          <button id="upload-btn">Upload</button>
          <span class="muted" id="greeting">Hello, guest</span>
        </div>
      </header>
      <div class="app">
        <div class="card" style="overflow: auto;">
          <table class="files" id="file-table">
            <thead>
              <tr>
                <th style="width:50%;">Name</th>
                <th style="width:20%;">Size</th>
                <th style="width:30%;">Last modified</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="file-tbody"></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
  <!-- Hidden file input for upload -->
  <input type="file" id="file-input" accept=".drawio" style="display: none;" />
  <!-- Settings modal -->
  <div id="settings-backdrop" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 40;"></div>
  <div id="settings-modal" class="card" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: min(440px, 92vw); padding: 16px; z-index: 50;">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
      <strong>Settings</strong>
      <button id="settings-close">Close</button>
    </div>
    <div style="display:grid; gap:8px;">
      <label class="muted">Display name</label>
      <input id="settings-name" placeholder="display name" />
      <button id="settings-save">Save</button>
    </div>
  </div>
  <script>
    const $ = (id) => document.getElementById(id);
    const greeting = $('greeting');
    const statusEl = $('status');
    const versionBadge = $('version-badge');
    const crumbs = $('crumbs');
    const fileBody = $('file-tbody');

    let cwd = '';
    
    // Helper function to add token to URLs
    function addTokenToUrl(url) {
      const storedToken = localStorage.getItem('drawio_token');
      if (!storedToken) return url;
      const separator = url.includes('?') ? '&' : '?';
      return `${url}${separator}token=${encodeURIComponent(storedToken)}`;
    }

    async function fetchJSON(url, opts = {}) {
      const res = await fetch(addTokenToUrl(url), { credentials: 'include', ...opts });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }
    async function fetchText(url, opts = {}) {
      const res = await fetch(addTokenToUrl(url), { credentials: 'include', ...opts });
      if (!res.ok) throw new Error(await res.text());
      return res.text();
    }

    async function refreshMe() {
      try {
        const me = await fetchJSON('/me');
        greeting.textContent = 'Hello, ' + me.username;
        // Store token from URL if present (for persistence across sessions)
        const urlToken = new URLSearchParams(location.search).get('token');
        if (urlToken) {
          localStorage.setItem('drawio_token', urlToken);
          // Clean URL to remove token from address bar
          const url = new URL(location);
          url.searchParams.delete('token');
          history.replaceState({}, '', url);
        }
      } catch {
        greeting.textContent = 'Hello, guest';
      }
    }
    async function refreshFiles() {
      fileBody.innerHTML = '';
      try {
        updateBreadcrumbs();
        const files = await fetchJSON('/api/list?path=' + encodeURIComponent(cwd));
        const q = ($('filter')?.value || '').toLowerCase();
        for (const f of files.filter(x => !q || x.name.toLowerCase().includes(q))) {
          const tr = document.createElement('tr');
          const tdName = document.createElement('td');
          const tdSize = document.createElement('td');
          const tdMod = document.createElement('td');
          const tdAct = document.createElement('td');
          const nameCell = document.createElement('div');
          nameCell.className = 'namecell';
          const dot = document.createElement('span');
          dot.className = 'icon ' + (f.is_dir ? 'folder' : 'file');
          const label = document.createElement('div');
          label.textContent = f.name + (f.is_dir ? '/' : '');
          label.style.whiteSpace = 'nowrap';
          label.style.overflow = 'hidden';
          label.style.textOverflow = 'ellipsis';
          nameCell.appendChild(dot);
          nameCell.appendChild(label);
          tdName.appendChild(nameCell);
          tdName.style.cursor = 'pointer';
          tdName.onclick = () => {
            if (f.is_dir) {
              cwd = f.path;
              refreshFiles();
            } else {
              const token = localStorage.getItem('drawio_token') || '';
              const url = `/drawio.html?path=${encodeURIComponent(f.path)}${token ? '&token=' + encodeURIComponent(token) : ''}`;
              window.location.href = url;
            }
          };
          tdSize.textContent = f.is_dir ? '–' : formatSize(f.size || 0);
          tdMod.textContent = f.modified_ms ? formatRelative(f.modified_ms) : '–';
          const actions = document.createElement('div');
          actions.className = 'row-actions';
          const btnOpen = document.createElement('a');
          btnOpen.className = 'button';
          btnOpen.textContent = 'Open';
          const token = localStorage.getItem('drawio_token') || '';
          btnOpen.href = f.is_dir ? '#' : `/drawio.html?path=${encodeURIComponent(f.path)}${token ? '&token=' + encodeURIComponent(token) : ''}`;
          btnOpen.onclick = (ev) => { if (f.is_dir) { ev.preventDefault(); cwd = f.path; refreshFiles(); } };
          const btnDownload = document.createElement('a');
          btnDownload.className = 'button';
          btnDownload.textContent = 'Download';
          btnDownload.href = `/api/download?path=${encodeURIComponent(f.path)}`;
          btnDownload.style.display = f.is_dir ? 'none' : 'inline-block';
          const btnRename = document.createElement('button');
          btnRename.textContent = 'Rename';
          btnRename.onclick = async () => {
            const newName = prompt('Rename to:', f.name);
            if (!newName || newName === f.name) return;
            if (!f.is_dir && !newName.endsWith('.drawio')) return alert('Name must end with .drawio');
            try {
              const res = await fetch(addTokenToUrl('/api/rename'), {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ from: f.path, to: (cwd ? (cwd + '/' + newName) : newName) }),
              });
              if (!res.ok) throw new Error(await res.text());
              await refreshFiles();
            } catch (e) { alert(e.message); }
          };
          const btnDelete = document.createElement('button');
          btnDelete.textContent = 'Delete';
          btnDelete.onclick = async () => {
            if (!confirm(`Delete ${f.name}${f.is_dir ? ' (folders must be empty)' : ''}?`)) return;
            try {
              if (f.is_dir) {
                alert('Folder deletion not implemented yet');
                return;
              }
              const res = await fetch(addTokenToUrl(`/api/file?path=${encodeURIComponent(f.path)}`), {
                method: 'DELETE',
                credentials: 'include',
              });
              if (!res.ok) throw new Error(await res.text());
              await refreshFiles();
            } catch (e) { alert(e.message); }
          };
          actions.appendChild(btnOpen);
          actions.appendChild(btnDownload);
          actions.appendChild(btnRename);
          actions.appendChild(btnDelete);
          tdAct.appendChild(actions);
          tr.appendChild(tdName);
          tr.appendChild(tdSize);
          tr.appendChild(tdMod);
          tr.appendChild(tdAct);
          fileBody.appendChild(tr);
        }
      } catch (e) {
        //console.error(e);
      }
    }

    // Settings modal open/close/save
    const settingsBtn = $('nav-settings');
    const settingsModal = $('settings-modal');
    const settingsBackdrop = $('settings-backdrop');
    const settingsClose = $('settings-close');
    const settingsSave = $('settings-save');
    const settingsName = $('settings-name');
    function openSettings() {
      settingsModal.style.display = 'block';
      settingsBackdrop.style.display = 'block';
      const current = (greeting.textContent || '').replace(/^Hello,\s*/, '') || 'guest';
      settingsName.value = current === 'guest' ? '' : current;
      settingsName.focus();
    }
    function closeSettings() {
      settingsModal.style.display = 'none';
      settingsBackdrop.style.display = 'none';
    }
    if (settingsBtn) settingsBtn.onclick = (e) => { e.preventDefault(); openSettings(); };
    if (settingsBackdrop) settingsBackdrop.onclick = closeSettings;
    if (settingsClose) settingsClose.onclick = closeSettings;
    if (settingsSave) settingsSave.onclick = async () => {
      const username = settingsName.value.trim();
      if (!username) return alert('enter a display name');
      try {
        // Use token from localStorage or URL query params as fallback
        const storedToken = localStorage.getItem('drawio_token');
        const urlToken = new URLSearchParams(location.search).get('token');
        const token = storedToken || urlToken || '';
        const res = await fetch('/me?token=' + encodeURIComponent(token), {
          method: 'PUT',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username }),
        });
        if (!res.ok) throw new Error(await res.text());
        await refreshMe();
        closeSettings();
      } catch (e) { alert(e.message); }
    };
    $('logout')?.addEventListener('click', async () => {
      await fetch(addTokenToUrl('/logout'), { method: 'POST', credentials: 'include' });
      // Clear stored token on logout
      localStorage.removeItem('drawio_token');
      // Redirect to login page
      location.href = '/token.html';
    });
    $('refresh').onclick = refreshFiles;
    $('nav-root').onclick = (e) => { e.preventDefault(); cwd = ''; refreshFiles(); };
    
    // Upload functionality
    const fileInput = $('file-input');
    const uploadBtn = $('upload-btn');
    const navUpload = $('nav-upload');
    
    async function handleFileUpload(file) {
      if (!file) return;
      
      // Check if file has .drawio extension
      if (!file.name.endsWith('.drawio')) {
        if (!confirm('File does not end with .drawio. Upload anyway? (extension will be added)')) {
          return;
        }
      }
      
      const formData = new FormData();
      formData.append('file', file);
      
      // Build URL with optional path query parameter
      let url = '/api/upload';
      if (cwd) {
        // If in a subdirectory, suggest the path with the filename
        const suggestedPath = cwd + '/' + file.name;
        url += '?path=' + encodeURIComponent(suggestedPath);
      }
      
      try {
        const res = await fetch(addTokenToUrl(url), {
          method: 'POST',
          credentials: 'include',
          body: formData,
        });
        
        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(errorText || 'Upload failed');
        }
        
        const result = await res.json();
        alert(`File uploaded successfully: ${result.path}`);
        await refreshFiles();
      } catch (e) {
        alert('Upload error: ' + e.message);
      }
    }
    
    fileInput.onchange = (e) => {
      const file = e.target.files?.[0];
      if (file) {
        handleFileUpload(file);
      }
      // Reset input so same file can be selected again
      fileInput.value = '';
    };
    
    if (uploadBtn) {
      uploadBtn.onclick = () => fileInput.click();
    }
    if (navUpload) {
      navUpload.onclick = () => fileInput.click();
    }
    
    $('nav-new-folder').onclick = async () => {
      const name = prompt('Folder name:');
      if (!name) return;
      const full = cwd ? (cwd + '/' + name) : name;
      const res = await fetch(addTokenToUrl('/api/mkdir'), { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ path: full }) });
      if (!res.ok) return alert(await res.text());
      refreshFiles();
    };
    $('nav-new-file').onclick = async () => {
      const name = prompt('New diagram name (ends with .drawio):');
      if (!name || !name.endsWith('.drawio')) return;
      const full = cwd ? (cwd + '/' + name) : name;
      const content = getTemplateXml('blank');
      const res = await fetch(addTokenToUrl(`/api/file?path=${encodeURIComponent(full)}`), { method: 'PUT', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content }) });
      if (!res.ok) return alert(await res.text());
      refreshFiles();
    };

    function updateBreadcrumbs() {
      const parts = cwd ? cwd.split('/') : [];
      crumbs.innerHTML = '';
      const root = document.createElement('a');
      root.href = '#';
      root.textContent = 'root';
      root.className = 'button';
      root.onclick = () => { cwd = ''; refreshFiles(); };
      crumbs.appendChild(root);
      let pathAcc = '';
      for (const p of parts) {
        pathAcc = pathAcc ? (pathAcc + '/' + p) : p;
        const a = document.createElement('a');
        a.href = '#';
        a.textContent = p;
        a.className = 'button';
        const jump = pathAcc;
        a.onclick = (e) => { e.preventDefault(); cwd = jump; refreshFiles(); };
        crumbs.appendChild(a);
      }
    }

    function formatSize(n) {
      const units = ['B','KB','MB','GB','TB'];
      let i = 0; let x = n;
      while (x >= 1024 && i < units.length - 1) { x /= 1024; i++; }
      return (i === 0 ? x : x.toFixed(2)) + ' ' + units[i];
    }
    function formatRelative(ms) {
      const now = Date.now();
      const d = Math.max(0, now - ms);
      const s = Math.floor(d / 1000);
      if (s < 60) return 'just now';
      const m = Math.floor(s / 60);
      if (m < 60) return `${m} minute${m===1?'':'s'} ago`;
      const h = Math.floor(m / 60);
      if (h < 24) return `${h} hour${h===1?'':'s'} ago`;
      const days = Math.floor(h / 24);
      return `${days} day${days===1?'':'s'} ago`;
    }
    function getTemplateXml(kind) {
      if (kind === 'flow') {
        return '<?xml version="1.0" encoding="UTF-8"?><mxfile><diagram name="Page-1"><mxGraphModel><root><mxCell id="0"/><mxCell id="1" parent="0"/><mxCell id="2" value="Start" style="ellipse;whiteSpace=wrap;html=1;aspect=fixed;" vertex="1" parent="1"><mxGeometry x="120" y="80" width="80" height="80" as="geometry"/></mxCell><mxCell id="3" value="Process" style="rounded=1;whiteSpace=wrap;html=1;" vertex="1" parent="1"><mxGeometry x="260" y="80" width="120" height="60" as="geometry"/></mxCell><mxCell id="4" edge="1" parent="1" source="2" target="3"><mxGeometry relative="1" as="geometry"/></mxCell></root></mxGraphModel></diagram></mxfile>';
      }
      return '<?xml version="1.0" encoding="UTF-8"?><mxfile><diagram name="Page-1"><mxGraphModel><root><mxCell id="0"/><mxCell id="1" parent="0"/></root></mxGraphModel></diagram></mxfile>';
    }

    refreshMe();
    refreshFiles();
    // load viewer script for previews
    (function loadViewer(){
      const s = document.createElement('script');
      s.src = 'https://viewer.diagrams.net/js/viewer.min.js';
      s.async = true;
      document.body.appendChild(s);
    })();
  </script>
</body>
</html>


